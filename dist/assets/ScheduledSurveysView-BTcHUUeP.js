import{l as f,y as H,O,W as z,s as Y,n as $,o as j,d as y,i as g,e,w as k,$ as E,t as h,f as m,F,r as M,h as W,q as G,j as p,k as C,A as Q,R as J,aj as K,U as X,am as Z,ac as ee,v as te}from"./index-9XWXAznh.js";import{_ as se}from"./Header-CQM0Mtxj.js";import{A as ae}from"./arrow-left-Q60brOqV.js";const x=f([]),re=f([]),ne=async(s,n)=>new Promise(t=>{setTimeout(()=>{const a={id:`schedule-${Date.now()}`,surveyId:s.id||`survey-${Date.now()}`,surveyTitle:s.titulo,...n,status:"active",createdAt:new Date().toISOString(),createdBy:"admin@demo.com",nextSendDate:ie(n),totalSent:0,lastSentDate:null};x.value.push(a),console.log("Recurring schedule created:",a),t({success:!0,schedule:a,message:"Programación recurrente creada exitosamente"})},500)}),oe=async()=>new Promise(s=>{setTimeout(()=>{s([...x.value])},300)}),le=async(s,n)=>new Promise((t,a)=>{setTimeout(()=>{const l=x.value.findIndex(b=>b.id===s);if(l===-1){a(new Error("Schedule not found"));return}x.value[l]={...x.value[l],...n,updatedAt:new Date().toISOString()},t({success:!0,schedule:x.value[l]})},400)}),de=async s=>new Promise((n,t)=>{setTimeout(()=>{const a=x.value.findIndex(l=>l.id===s);if(a===-1){t(new Error("Schedule not found"));return}x.value[a].status="cancelled",x.value[a].cancelledAt=new Date().toISOString(),n({success:!0,message:"Programación cancelada exitosamente"})},300)}),ce=async s=>new Promise(n=>{setTimeout(()=>{const t=re.value.filter(a=>a.scheduleId===s);n(t)},200)}),ie=s=>{if(!s.startDate)return null;const n=new Date;let t=new Date(s.startDate);if(t<=n)switch(s.frequency){case"daily":for(;t<=n;)t.setDate(t.getDate()+1);break;case"weekly":for(;t<=n;)t.setDate(t.getDate()+7);break;case"biweekly":for(;t<=n;)t.setDate(t.getDate()+14);break;case"monthly":for(;t<=n;)t.setMonth(t.getMonth()+1);break;case"quarterly":for(;t<=n;)t.setMonth(t.getMonth()+3);break;case"yearly":for(;t<=n;)t.setFullYear(t.getFullYear()+1);break;case"custom":const a=parseInt(s.customInterval);for(;t<=n;)s.customUnit==="days"?t.setDate(t.getDate()+a):s.customUnit==="weeks"?t.setDate(t.getDate()+a*7):s.customUnit==="months"&&t.setMonth(t.getMonth()+a);break}if(s.sendTime){const[a,l]=s.sendTime.split(":");t.setHours(parseInt(a),parseInt(l),0,0)}return t.toISOString()},ue=s=>{const n=[];if(s.frequency||n.push("Frecuencia es requerida"),s.startDate||n.push("Fecha de inicio es requerida"),s.sendTime||n.push("Hora de envío es requerida"),s.activeDuration||n.push("Duración activa es requerida"),["weekly","biweekly"].includes(s.frequency)&&s.daysOfWeek.length===0&&n.push("Selecciona al menos un día de la semana"),["monthly","quarterly","yearly"].includes(s.frequency)&&!s.dayOfMonth&&n.push("Selecciona un día del mes"),s.frequency==="custom"&&((!s.customInterval||s.customInterval<1)&&n.push("Intervalo personalizado debe ser mayor a 0"),s.customUnit||n.push("Unidad de intervalo es requerida")),s.startDate&&s.endDate){const t=new Date(s.startDate);new Date(s.endDate)<=t&&n.push("Fecha de finalización debe ser posterior a la fecha de inicio")}return{isValid:n.length===0,errors:n}},me=async(s=5)=>new Promise(n=>{setTimeout(()=>{const t=x.value.filter(a=>a.status==="active"&&a.nextSendDate).sort((a,l)=>new Date(a.nextSendDate)-new Date(l.nextSendDate)).slice(0,s).map(a=>({id:a.id,surveyTitle:a.surveyTitle,nextSendDate:a.nextSendDate,frequency:a.frequency,recipientCount:50}));n(t)},200)}),he=H("scheduling",()=>{const s=f([]),n=f([]),t=f([]),a=f(!1),l=f(null);return{scheduledSurveys:s,upcomingSchedules:n,scheduleHistory:t,loading:a,error:l,createSchedule:async(u,d)=>{a.value=!0,l.value=null;try{const i=ue(d);if(!i.isValid)throw new Error(`Configuración inválida: ${i.errors.join(", ")}`);const v=await ne(u,d);if(v.success)return s.value.push(v.schedule),console.log("Schedule created successfully:",v.schedule),v}catch(i){throw l.value=i.message||"Error al crear la programación",console.error("Error creating schedule:",i),i}finally{a.value=!1}},loadScheduledSurveys:async()=>{a.value=!0,l.value=null;try{const u=await oe();s.value=u}catch(u){l.value=u.message||"Error al cargar las programaciones",console.error("Error loading scheduled surveys:",u)}finally{a.value=!1}},loadUpcomingSchedules:async(u=5)=>{a.value=!0,l.value=null;try{const d=await me(u);n.value=d}catch(d){l.value=d.message||"Error al cargar próximos envíos",console.error("Error loading upcoming schedules:",d)}finally{a.value=!1}},updateScheduleConfig:async(u,d)=>{a.value=!0,l.value=null;try{const i=await le(u,d);if(i.success){const v=s.value.findIndex(D=>D.id===u);return v!==-1&&(s.value[v]=i.schedule),console.log("Schedule updated successfully"),i}}catch(i){throw l.value=i.message||"Error al actualizar la programación",console.error("Error updating schedule:",i),i}finally{a.value=!1}},cancelScheduleById:async u=>{a.value=!0,l.value=null;try{const d=await de(u);if(d.success){const i=s.value.findIndex(v=>v.id===u);return i!==-1&&(s.value[i].status="cancelled"),console.log("Schedule cancelled successfully"),d}}catch(d){throw l.value=d.message||"Error al cancelar la programación",console.error("Error cancelling schedule:",d),d}finally{a.value=!1}},loadScheduleHistory:async u=>{a.value=!0,l.value=null;try{const d=await ce(u);t.value=d}catch(d){l.value=d.message||"Error al cargar el historial",console.error("Error loading schedule history:",d)}finally{a.value=!1}}}}),ye={class:"min-h-screen bg-gray-50"},pe={class:"py-8"},ve={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"},ge={class:"mb-8"},xe={class:"flex justify-between items-center"},we={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},fe={class:"bg-white rounded-lg shadow-sm p-6 text-center"},be={class:"text-2xl font-bold text-primary"},Se={class:"bg-white rounded-lg shadow-sm p-6 text-center"},_e={class:"text-2xl font-bold text-green-600"},De={class:"bg-white rounded-lg shadow-sm p-6 text-center"},ke={class:"text-2xl font-bold text-blue-600"},Ee={class:"bg-white rounded-lg shadow-sm p-6 text-center"},Ce={class:"text-2xl font-bold text-orange-600"},Ie={key:0,class:"bg-white rounded-lg shadow-sm p-8 text-center"},Pe={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-6 text-center"},Te={class:"text-red-600 mb-4"},qe={key:2,class:"bg-white rounded-lg shadow-sm p-12 text-center"},$e={key:3,class:"space-y-6"},Fe={key:0,class:"bg-white rounded-lg shadow-sm overflow-hidden"},Me={class:"p-6"},Ae={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},Ue={class:"font-medium text-blue-900 mb-2"},Re={class:"space-y-1 text-sm text-blue-700"},Le={class:"flex items-center"},Ne={class:"flex items-center"},Ve={class:"bg-white rounded-lg shadow-sm overflow-hidden"},Be={class:"overflow-x-auto"},He={class:"min-w-full divide-y divide-gray-200"},Oe={class:"bg-white divide-y divide-gray-200"},ze={class:"px-6 py-4 whitespace-nowrap"},Ye={class:"text-sm font-medium text-gray-900"},je={class:"text-sm text-gray-500"},We={class:"px-6 py-4 whitespace-nowrap"},Ge={class:"text-sm text-gray-900"},Qe={class:"px-6 py-4 whitespace-nowrap"},Je={key:0,class:"text-sm text-gray-900"},Ke={key:1,class:"text-sm text-gray-500"},Xe={class:"px-6 py-4 whitespace-nowrap"},Ze={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},et={class:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2"},tt=["onClick","disabled"],st=["onClick","disabled"],at=["onClick","disabled"],rt={__name:"ScheduledSurveysView",setup(s){const n=G(),t=z(),a=he(),{scheduledSurveys:l,upcomingSchedules:b,loading:I,error:_}=Y(a),{loadScheduledSurveys:S,loadUpcomingSchedules:P,updateScheduleConfig:T,cancelScheduleById:u}=a,d=$(()=>l.value.filter(c=>c.status==="active").length),i=$(()=>{const c=new Date().getMonth(),r=new Date().getFullYear();return l.value.reduce((o,w)=>{if(w.lastSentDate){const q=new Date(w.lastSentDate);if(q.getMonth()===c&&q.getFullYear()===r)return o+(w.totalSent||0)}return o},0)}),v=()=>{n.push("/admin/dashboard")},D=()=>{n.push("/admin/encuestas/crear")},A=c=>new Date(c).toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"}),U=c=>new Date(c).toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}),R=c=>({daily:"Diario",weekly:"Semanal",biweekly:"Quincenal",monthly:"Mensual",quarterly:"Trimestral",yearly:"Anual",custom:"Personalizado"})[c]||c,L=c=>({active:"Activa",paused:"Pausada",cancelled:"Cancelada",completed:"Completada"})[c]||c,N=c=>{t.add({severity:"info",summary:"Función en desarrollo",detail:"La edición de programaciones estará disponible próximamente",life:4e3})},V=async c=>{const r=c.status==="active"?"paused":"active",o=r==="active"?"reanudar":"pausar";try{await T(c.id,{status:r}),t.add({severity:"success",summary:`Programación ${o==="pausar"?"pausada":"reanudada"}`,detail:`La encuesta "${c.surveyTitle}" ha sido ${o==="pausar"?"pausada":"reanudada"}`,life:4e3}),await S()}catch{t.add({severity:"error",summary:"Error",detail:`No se pudo ${o} la programación`,life:5e3})}},B=async(c,r)=>{if(confirm(`¿Estás seguro de que quieres cancelar la programación de "${r}"?

Esta acción no se puede deshacer.`))try{await u(c),t.add({severity:"success",summary:"Programación cancelada",detail:`La programación de "${r}" ha sido cancelada`,life:4e3}),await S()}catch{t.add({severity:"error",summary:"Error",detail:"No se pudo cancelar la programación",life:5e3})}};return j(async()=>{await S(),await P()}),(c,r)=>(p(),y("div",ye,[g(se,{subtitulo:"Encuestas Programadas"}),e("div",pe,[e("div",ve,[e("div",ge,[e("div",xe,[r[1]||(r[1]=e("div",null,[e("h1",{class:"text-3xl font-bold text-gray-900"},"Encuestas Programadas"),e("p",{class:"mt-2 text-lg text-gray-600"},"Gestiona las encuestas recurrentes y sus cronogramas")],-1)),g(E,{onClick:v,variant:"outline"},{default:k(()=>[g(m(ae),{class:"h-5 w-5 mr-2"}),r[0]||(r[0]=C(" Volver al Dashboard "))]),_:1,__:[0]})])]),e("div",we,[e("div",fe,[e("div",be,h(m(l).length),1),r[2]||(r[2]=e("div",{class:"text-sm text-gray-500"},"Total Programadas",-1))]),e("div",Se,[e("div",_e,h(d.value),1),r[3]||(r[3]=e("div",{class:"text-sm text-gray-500"},"Activas",-1))]),e("div",De,[e("div",ke,h(m(b).length),1),r[4]||(r[4]=e("div",{class:"text-sm text-gray-500"},"Próximos Envíos",-1))]),e("div",Ee,[e("div",Ce,h(i.value),1),r[5]||(r[5]=e("div",{class:"text-sm text-gray-500"},"Enviadas Este Mes",-1))])]),m(I)?(p(),y("div",Ie,r[6]||(r[6]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-2 border-primary border-t-transparent mx-auto mb-4"},null,-1),e("p",{class:"text-gray-600"},"Cargando encuestas programadas...",-1)]))):m(_)?(p(),y("div",Pe,[g(m(Q),{class:"h-12 w-12 text-red-500 mx-auto mb-4"}),r[8]||(r[8]=e("h3",{class:"text-lg font-medium text-red-800 mb-2"},"Error al cargar las programaciones",-1)),e("p",Te,h(m(_)),1),g(E,{onClick:m(S),variant:"outline"},{default:k(()=>[g(m(J),{class:"h-4 w-4 mr-2"}),r[7]||(r[7]=C(" Reintentar "))]),_:1,__:[7]},8,["onClick"])])):m(l).length===0?(p(),y("div",qe,[g(m(K),{class:"h-16 w-16 text-gray-400 mx-auto mb-4"}),r[10]||(r[10]=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"No hay encuestas programadas",-1)),r[11]||(r[11]=e("p",{class:"text-gray-500 mb-6"},"Crea una encuesta recurrente para comenzar",-1)),g(E,{onClick:D},{default:k(()=>[g(m(X),{class:"h-4 w-4 mr-2"}),r[9]||(r[9]=C(" Crear Encuesta Recurrente "))]),_:1,__:[9]})])):(p(),y("div",$e,[m(b).length>0?(p(),y("div",Fe,[r[12]||(r[12]=e("div",{class:"bg-blue-50 px-6 py-4 border-b border-blue-200"},[e("h3",{class:"text-lg font-semibold text-blue-900"},"Próximos Envíos Programados")],-1)),e("div",Me,[e("div",Ae,[(p(!0),y(F,null,M(m(b),o=>(p(),y("div",{key:o.id,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},[e("h4",Ue,h(o.surveyTitle),1),e("div",Re,[e("div",Le,[g(m(Z),{class:"h-4 w-4 mr-2"}),e("span",null,h(U(o.nextSendDate)),1)]),e("div",Ne,[g(m(ee),{class:"h-4 w-4 mr-2"}),e("span",null,h(o.recipientCount)+" destinatarios",1)])])]))),128))])])])):W("",!0),e("div",Ve,[r[14]||(r[14]=e("div",{class:"bg-gray-50 px-6 py-4 border-b border-gray-200"},[e("h3",{class:"text-lg font-semibold text-gray-900"},"Todas las Programaciones")],-1)),e("div",Be,[e("table",He,[r[13]||(r[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Encuesta "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Frecuencia "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Próximo Envío "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Estado "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Enviadas "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Acciones ")])],-1)),e("tbody",Oe,[(p(!0),y(F,null,M(m(l),o=>(p(),y("tr",{key:o.id,class:"hover:bg-gray-50"},[e("td",ze,[e("div",null,[e("div",Ye,h(o.surveyTitle),1),e("div",je,"ID: "+h(o.surveyId),1)])]),e("td",We,[e("span",Ge,h(R(o.frequency)),1)]),e("td",Qe,[o.nextSendDate?(p(),y("div",Je,h(A(o.nextSendDate)),1)):(p(),y("div",Ke,"-"))]),e("td",Xe,[e("span",{class:te(["px-2 py-1 rounded-full text-xs font-medium",o.status==="active"?"bg-green-100 text-green-800":o.status==="paused"?"bg-yellow-100 text-yellow-800":o.status==="cancelled"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"])},h(L(o.status)),3)]),e("td",Ze,h(o.totalSent||0),1),e("td",et,[e("button",{onClick:w=>N(o.id),class:"text-blue-600 hover:text-blue-900",disabled:o.status==="cancelled"}," Editar ",8,tt),e("button",{onClick:w=>V(o),class:"text-yellow-600 hover:text-yellow-900",disabled:o.status==="cancelled"},h(o.status==="active"?"Pausar":"Reanudar"),9,st),e("button",{onClick:w=>B(o.id,o.surveyTitle),class:"text-red-600 hover:text-red-900",disabled:o.status==="cancelled"}," Cancelar ",8,at)])]))),128))])])])])]))])])]))}},dt=O(rt,[["__scopeId","data-v-f0087b4e"]]);export{dt as default};
